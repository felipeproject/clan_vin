<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campeonato de Duplas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="styles.css"> <!-- Link para o CSS externo -->
</head>

<body>

    <!-- Botão de Voltar -->
    <button class="button" onclick="window.history.back()">Voltar</button>

    <h1>Campeonato de Duplas</h1>

    <!-- Container principal para as tabelas -->
    <div class="container">
        <!-- Tabela Geral (Classificação Geral) -->
        <table id="classificacao-table">
            <caption><strong>
                    <h1>Classificação Geral</h1>
                </strong></caption>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Nome</th>
                    <th>Kills</th>
                    <th>Partidas Disputadas</th>
                    <th>Total Pontuação</th>
                </tr>
            </thead>
            <tbody id="classificacao-body">
                <!-- Dados da classificação geral serão inseridos aqui -->
            </tbody>
        </table>

        <!-- Coluna para Top 5 e Rodadas -->
        <div class="flex-column">
            <!-- Navegação entre as tabelas de resultados de jogos -->
    
            <!-- Tabela de Rodadas -->
            <div id="nav-buttons">
                <caption><strong>
                        <h3>Rodadas</h3>
                    </strong></caption>
                <button id="prev-btn" onclick="navigateTable(-1)" disabled>←</button>
                <button id="next-btn" onclick="navigateTable(1)"> →</button>
            </div>
            <table id="tables">
                <thead>
                </thead>
                <tbody id="tables-body">
                    <!-- Dados das rodadas serão inseridos aqui -->
                </tbody>
            </table>
            <!-- Tabela Top 5 Kills -->
            <table id="top5-table">
                <caption>
                    <h1>Top 5 Kills<h1>
                </caption>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Nome</th>
                        <th>Kills</th>
                    </tr>
                </thead>
                <tbody id="top5-body">
                    <!-- Dados do Top 5 Kills serão inseridos aqui -->
                </tbody>
            </table>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Carregar a lista de partidas do arquivo JSON
            fetch('partidas.json')
                .then(response => response.json()) // Lê o arquivo JSON
                .then(data => {
                    const csvFiles = data.partidas || [];  // Obter a lista de arquivos CSV
                    const tablesContainer = document.getElementById('tables-body');
                    const classificacaoBody = document.getElementById('classificacao-body');
                    const top5Body = document.getElementById('top5-body');
                    let jogadores = {}; // Armazenará dados de jogadores
                    let tables = []; // Array para armazenar as tabelas das partidas
                    let currentTableIndex = 0; // Índice da tabela atual

                    // Sistema de pontuação
                    const pontuacaoPosicional = {
                        1: 10,
                        2: 9,
                        3: 8,
                        4: 7,
                        5: 6,
                        6: 5,
                        7: 4,
                        8: 3,
                        9: 2,
                        10: 1
                    };

                    // Processar os arquivos CSV conforme a ordem no JSON
                    csvFiles.forEach((file, index) => {
                        fetch(file)
                            .then(response => response.text()) // Lê o arquivo CSV como texto
                            .then(csvData => {
                                Papa.parse(csvData, {
                                    header: true, // Diz que a primeira linha é o cabeçalho
                                    skipEmptyLines: true, // Ignora linhas vazias
                                    complete: function (results) {
                                        // Processa os dados da partida
                                        results.data.forEach((rowData, i) => {
                                            const jogador = rowData['Name']; // Nome do jogador
                                            const kills = parseInt(rowData['Kills'], 10) || 0; // Kills do jogador
                                            const posicao = i + 1; // Posição do jogador na partida (index + 1)
                                            const pontosPosicionais = pontuacaoPosicional[posicao] || 0; // Pontuação posicional
                                            const totalPontos = kills + pontosPosicionais; // Total de pontos (kills + posição)

                                            // Atualiza os dados do jogador
                                            if (!jogadores[jogador]) {
                                                jogadores[jogador] = {
                                                    kills: 0,
                                                    pontos: 0,
                                                    partidas: 0
                                                };
                                            }

                                            jogadores[jogador].kills += kills;
                                            jogadores[jogador].pontos += totalPontos;
                                            jogadores[jogador].partidas += 1; // Incrementa a quantidade de partidas disputadas
                                        });

                                        // Gerar a tabela do jogo e adicioná-la ao array
                                        const tableElement = generateTable(results.data, file, index + 1);
                                        tables.push(tableElement);
                                        tablesContainer.appendChild(tableElement);

                                        // Inicializa a primeira tabela
                                        if (index === 0) {
                                            tableElement.style.display = 'block'; // Exibe a primeira tabela
                                        } else {
                                            tableElement.style.display = 'none'; // Mantém as outras tabelas ocultas
                                        }
                                    },
                                    error: function (error) {
                                        console.error('Erro ao processar o CSV:', error);
                                    }
                                });
                            })
                            .catch(err => console.error('Erro ao carregar o CSV:', err));
                    });

                    // Função para navegar entre as tabelas
                    function navigateTable(direction) {
                        // Esconde a tabela atual
                        tables[currentTableIndex].style.display = 'none';

                        // Atualiza o índice da tabela atual
                        currentTableIndex += direction;

                        // Exibe a nova tabela
                        tables[currentTableIndex].style.display = 'block';

                        // Atualiza os botões de navegação
                        document.getElementById('prev-btn').disabled = currentTableIndex === 0;
                        document.getElementById('next-btn').disabled = currentTableIndex === tables.length - 1;
                    }

                    // Expondo a função para navegação
                    window.navigateTable = navigateTable;

                    // Quando todos os arquivos CSV forem processados, atualiza a classificação geral
                    setTimeout(() => {
                        updateClassificacao(jogadores);
                        updateTop5(jogadores);  // Atualiza a tabela de Top 5 Kills
                    }, 1000);
                })
                .catch(err => console.error('Erro ao carregar o arquivo JSON:', err));
        });

        // Função para atualizar a tabela de classificação geral
        function updateClassificacao(jogadores) {
            const classificacaoBody = document.getElementById('classificacao-body');

            // Ordena os jogadores por total de pontos (em ordem decrescente)
            const jogadoresOrdenados = Object.keys(jogadores)
                .map(jogador => ({
                    jogador,
                    kills: jogadores[jogador].kills,
                    pontos: jogadores[jogador].pontos,
                    partidas: jogadores[jogador].partidas
                }))
                .sort((a, b) => b.pontos - a.pontos || b.kills - a.kills || b.partidas - a.partidas); // Ordena por pontos, kills e partidas

            // Limpa a tabela de classificação
            classificacaoBody.innerHTML = '';

            // Preenche a tabela com os jogadores e seus pontos
            jogadoresOrdenados.forEach((item, index) => {
                const tr = document.createElement('tr');
                const tdRank = document.createElement('td');
                tdRank.textContent = index + 1;
                const tdName = document.createElement('td');
                tdName.textContent = item.jogador;
                const tdKills = document.createElement('td');
                tdKills.textContent = item.kills;
                const tdPartidas = document.createElement('td');
                tdPartidas.textContent = item.partidas;
                const tdPontos = document.createElement('td');
                tdPontos.textContent = item.pontos;

                tr.appendChild(tdRank);
                tr.appendChild(tdName);
                tr.appendChild(tdKills);
                tr.appendChild(tdPartidas);
                tr.appendChild(tdPontos);
                classificacaoBody.appendChild(tr);
            });
        }

        // Função para atualizar a tabela de Top 5 Kills
        function updateTop5(jogadores) {
            const top5Body = document.getElementById('top5-body');

            // Ordena os jogadores por kills de forma decrescente
            const jogadoresOrdenados = Object.keys(jogadores)
                .map(jogador => ({
                    jogador,
                    kills: jogadores[jogador].kills
                }))
                .sort((a, b) => b.kills - a.kills); // Ordena por kills de forma decrescente

            // Limpa a tabela de Top 5 Kills
            top5Body.innerHTML = '';

            // Preenche a tabela com os top 5 jogadores com mais kills
            jogadoresOrdenados.slice(0, 5).forEach((item, index) => {
                const tr = document.createElement('tr');
                const tdRank = document.createElement('td');
                tdRank.textContent = index + 1;
                const tdName = document.createElement('td');
                tdName.textContent = item.jogador;
                const tdKills = document.createElement('td');
                tdKills.textContent = item.kills;

                tr.appendChild(tdRank);
                tr.appendChild(tdName);
                tr.appendChild(tdKills);
                top5Body.appendChild(tr);
            });
        }

        // Função para gerar a tabela de resultados de jogo
        function generateTable(data, fileName, jogoIndex) {
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');

            if (data.length > 0) {
                const headers = Object.keys(data[0]);
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);

                data.forEach(rowData => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = rowData[header];
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
            }

            // Gerar título baseado no nome do arquivo CSV
            const title = document.createElement('h2');
            const fileNameWithoutExtension = fileName.split('/').pop().replace('.csv', '');
            const mapa = fileNameWithoutExtension.split('_')[0];
            const dataHora = fileNameWithoutExtension.split('_').slice(3).join(' ').replace('UTC', '');
            const dataFormatada = dataHora.replace('_', '/').replace('_', ' ');
            title.textContent = `Jogo #${jogoIndex} - ${mapa.charAt(0).toUpperCase() + mapa.slice(1)} (${dataFormatada})`;
            table.insertBefore(title, table.firstChild);

            return table;
        }
    </script>
</body>

</html>