<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campeonato de Solos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="campeonato-solos-T2.css">
</head>

<body>

    <button class="back-button" onclick="window.history.back();">Voltar</button>
    <h1>Campeonato de Solos</h1>

    <div class="container">
        <table id="classificacao-table">
            <caption>Classificação Geral</caption>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Nome</th>
                    <th>Kills</th>
                    <th>Partidas Disputadas</th>
                    <th>Total Pontuação</th>
                </tr>
            </thead>
            <tbody id="classificacao-body"></tbody>
        </table>

        <div class="flex-column">
            <div id="nav-buttons">
                <button id="prev-btn" onclick="navigateTable(-1)" disabled>←</button>
                <button id="next-btn" onclick="navigateTable(1)"> →</button>
            </div>
            <table id="tables">
                <thead></thead>
                <tbody id="tables-body"></tbody>
            </table>
            <table id="top5-table">
                <caption>Top 5 Kills</caption>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Nome</th>
                        <th>Kills</th>
                    </tr>
                </thead>
                <tbody id="top5-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const arquivosCSV = [
            "partida-1-Erangel.csv",
            "partida-2-Karakin.csv",
            "partida-3-Sanhok.csv",
            "partida-4-Miramar.csv",
            "partida-5-Taego.csv",
            "partida-6-Deston.csv",
            "partida-7-Vikendi.csv",
            "partida-8-Paramo.csv",
            "partida-9-Miramar.csv",
            "partida-10-Taego.csv"
        ];

        const tablesContainer = document.getElementById('tables-body');
        const classificacaoBody = document.getElementById('classificacao-body');
        const top5Body = document.getElementById('top5-body');
        let jogadores = {};
        let tables = [];
        let currentTableIndex = 0;
        let hasValidData = false;

        const pontuacaoPosicional = {
            1: 10,
            2: 9,
            3: 8,
            4: 7,
            5: 6,
            6: 5,
            7: 4,
            8: 3,
            9: 2,
            10: 1
        };

        const csvPromises = arquivosCSV.map((arquivoNome, index) => {
            return fetch('csv/' + arquivoNome + '?timestamp=' + new Date().getTime())
                .then(response => {
                    if (!response.ok) {
                        return Promise.reject('Arquivo não encontrado: ' + arquivoNome);
                    }
                    return response.text();
                })
                .then(csvData => {
                    return new Promise((resolve, reject) => {
                        Papa.parse(csvData, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function (results) {
                                if (results.data.length === 0) {
                                    return resolve();
                                }

                                hasValidData = true;

                                results.data.forEach((rowData, i) => {
                                    const jogador = rowData['Jogador'];
                                    const kills = parseInt(rowData['Kills'], 10) || 0;
                                    const posicao = parseInt(rowData['Posição'], 10);

                                    if (!jogadores[jogador]) {
                                        jogadores[jogador] = {
                                            kills: 0,
                                            pontos: 0,
                                            partidas: 0
                                        };
                                    }

                                    jogadores[jogador].kills += kills;

                                    if (pontuacaoPosicional[posicao]) {
                                        jogadores[jogador].pontos += pontuacaoPosicional[posicao];
                                    }

                                    jogadores[jogador].partidas += 1;
                                });

                                const tableElement = generateTable(results.data, arquivoNome, index + 1);
                                tables.push(tableElement);
                                tablesContainer.appendChild(tableElement);

                                if (index === 0) {
                                    tableElement.style.display = 'block';
                                } else {
                                    tableElement.style.display = 'none';
                                }

                                resolve();
                            },
                            error: function (error) {
                                reject(error);
                            }
                        });
                    });
                })
                .catch(err => console.error('Erro ao carregar o CSV:', err));
        });

        Promise.all(csvPromises).then(() => {
            if (hasValidData) {
                updateClassificacao(jogadores);
                updateTop5(jogadores);
            } else {
                document.getElementById('classificacao-table').style.display = 'none';
                document.getElementById('top5-table').style.display = 'none';
            }
        }).catch(err => console.error('Erro ao carregar algum dos CSVs:', err));

        function navigateTable(direction) {
            if (tables[currentTableIndex]) {
                tables[currentTableIndex].style.display = 'none';
            }

            currentTableIndex = Math.max(0, Math.min(currentTableIndex + direction, tables.length - 1));

            tables[currentTableIndex].style.display = 'block';

            document.getElementById('prev-btn').disabled = currentTableIndex === 0;
            document.getElementById('next-btn').disabled = currentTableIndex === tables.length - 1;
        }

        function updateClassificacao(jogadores) {
            const classificacaoBody = document.getElementById('classificacao-body');
            const classificacaoOrdenada = Object.keys(jogadores)
                .map(jogador => ({
                    jogador,
                    kills: jogadores[jogador].kills,
                    pontos: jogadores[jogador].pontos,
                    partidas: jogadores[jogador].partidas
                }))
                .sort((a, b) => {
                    if (b.pontos === a.pontos) {
                        return b.partidas - a.partidas;
                    }
                    return b.pontos - a.pontos;
                });

            classificacaoBody.innerHTML = '';

            classificacaoOrdenada.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML =
                    `<td>${index + 1}</td>
                    <td>${item.jogador}</td>
                    <td>${item.kills}</td>
                    <td>${item.partidas}</td>
                    <td>${item.pontos}</td>`;
                classificacaoBody.appendChild(tr);
            });
        }

        function updateTop5(jogadores) {
            const top5Body = document.getElementById('top5-body');
            const top5Ordenado = Object.keys(jogadores)
                .map(jogador => ({
                    jogador,
                    kills: jogadores[jogador].kills
                }))
                .sort((a, b) => b.kills - a.kills)
                .slice(0, 5);

            top5Body.innerHTML = '';

            top5Ordenado.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML =
                    `<td>${index + 1}</td>
                    <td>${item.jogador}</td>
                    <td>${item.kills}</td>`;
                top5Body.appendChild(tr);
            });
        }

        function generateTable(data, arquivoNome, numeroPartida) {
            const table = document.createElement('table');

            // Remover a extensão '.csv' do nome do arquivo
            const nomeSemExtensao = arquivoNome.replace('.csv', '');  // Remove a extensão '.csv'

            // Dividir o nome do arquivo sem a extensão para extrair o número da partida e o mapa
            const partes = nomeSemExtensao.split('-'); // Ex: "partida-2-Karakin"
            const partida = partes[1]; // "2"
            const mapa = partes[2]; // "Karakin"

            const caption = document.createElement('caption');
            caption.textContent = `Partida #${partida} - ${mapa}`;  // Exibir sem a extensão
            table.appendChild(caption);

            const thead = document.createElement('thead');
            thead.innerHTML =
                `<tr>
            <th>Posição</th>
            <th>Jogador</th>
            <th>Kills</th>
            <th>Pontos</th>
        </tr>`;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            data.forEach((rowData) => {
                const tr = document.createElement('tr');
                tr.innerHTML =
                    `<td>${rowData['Posição']}</td>
            <td>${rowData['Jogador']}</td>
            <td>${rowData['Kills']}</td>
            <td>${rowData['Pontos']}</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            return table;
        }

    </script>
</body>

</html>